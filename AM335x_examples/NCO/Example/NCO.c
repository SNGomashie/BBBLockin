#ifndef __AM335X_PRU_NCO_C_
#define __AM335X_PRU_NCO_C_

#include "NCO.h"

const uint16_t sinLUT[LUTSIZE] = {0000, 0xc9, 0x192, 0x25b, 0x324, 0x3ed, 0x4b6, 0x57e, 0x647, 0x710, 0x7d9, 0x8a1, 0x96a, 0xa32, 0xafb, 0xbc3, 0xc8b, 0xd53, 0xe1b, 0xee3, 0xfab, 0x1072, 0x1139, 0x1200, 0x12c7, 0x138e, 0x1455, 0x151b, 0x15e1, 0x16a7, 0x176d, 0x1833, 0x18f8, 0x19bd, 0x1a82, 0x1b46, 0x1c0b, 0x1ccf, 0x1d93, 0x1e56, 0x1f19, 0x1fdc, 0x209f, 0x2161, 0x2223, 0x22e4, 0x23a6, 0x2467, 0x2527, 0x25e7, 0x26a7, 0x2767, 0x2826, 0x28e5, 0x29a3, 0x2a61, 0x2b1e, 0x2bdb, 0x2c98, 0x2d54, 0x2e10, 0x2ecc, 0x2f86, 0x3041, 0x30fb, 0x31b4, 0x326d, 0x3326, 0x33de, 0x3496, 0x354d, 0x3603, 0x36b9, 0x376f, 0x3824, 0x38d8, 0x398c, 0x3a3f, 0x3af2, 0x3ba4, 0x3c56, 0x3d07, 0x3db7, 0x3e67, 0x3f16, 0x3fc5, 0x4073, 0x4120, 0x41cd, 0x4279, 0x4325, 0x43d0, 0x447a, 0x4523, 0x45cc, 0x4674, 0x471c, 0x47c3, 0x4869, 0x490e, 0x49b3, 0x4a57, 0x4afa, 0x4b9d, 0x4c3f, 0x4ce0, 0x4d80, 0x4e20, 0x4ebf, 0x4f5d, 0x4ffa, 0x5097, 0x5133, 0x51ce, 0x5268, 0x5301, 0x539a, 0x5432, 0x54c9, 0x555f, 0x55f4, 0x5689, 0x571d, 0x57b0, 0x5842, 0x58d3, 0x5963, 0x59f3, 0x5a81, 0x5b0f, 0x5b9c, 0x5c28, 0x5cb3, 0x5d3d, 0x5dc6, 0x5e4f, 0x5ed6, 0x5f5d, 0x5fe2, 0x6067, 0x60eb, 0x616e, 0x61f0, 0x6271, 0x62f1, 0x6370, 0x63ee, 0x646b, 0x64e7, 0x6562, 0x65dd, 0x6656, 0x66ce, 0x6745, 0x67bc, 0x6831, 0x68a5, 0x6919, 0x698b, 0x69fc, 0x6a6c, 0x6adb, 0x6b4a, 0x6bb7, 0x6c23, 0x6c8e, 0x6cf8, 0x6d61, 0x6dc9, 0x6e30, 0x6e95, 0x6efa, 0x6f5e, 0x6fc0, 0x7022, 0x7082, 0x70e1, 0x7140, 0x719d, 0x71f9, 0x7254, 0x72ae, 0x7306, 0x735e, 0x73b5, 0x740a, 0x745e, 0x74b1, 0x7503, 0x7554, 0x75a4, 0x75f3, 0x7640, 0x768d, 0x76d8, 0x7722, 0x776b, 0x77b3, 0x77f9, 0x783f, 0x7883, 0x78c6, 0x7908, 0x7949, 0x7989, 0x79c7, 0x7a04, 0x7a41, 0x7a7c, 0x7ab5, 0x7aee, 0x7b25, 0x7b5c, 0x7b91, 0x7bc4, 0x7bf7, 0x7c29, 0x7c59, 0x7c88, 0x7cb6, 0x7ce2, 0x7d0e, 0x7d38, 0x7d61, 0x7d89, 0x7db0, 0x7dd5, 0x7df9, 0x7e1c, 0x7e3e, 0x7e5e, 0x7e7e, 0x7e9c, 0x7eb9, 0x7ed4, 0x7eef, 0x7f08, 0x7f20, 0x7f37, 0x7f4c, 0x7f61, 0x7f74, 0x7f86, 0x7f96, 0x7fa6, 0x7fb4, 0x7fc1, 0x7fcd, 0x7fd7, 0x7fe0, 0x7fe8, 0x7fef, 0x7ff5, 0x7ff9, 0x7ffc, 0x7ffe, 0x7fff, 0x7ffe, 0x7ffc, 0x7ff9, 0x7ff5, 0x7fef, 0x7fe8, 0x7fe0, 0x7fd7, 0x7fcd, 0x7fc1, 0x7fb4, 0x7fa6, 0x7f96, 0x7f86, 0x7f74, 0x7f61, 0x7f4c, 0x7f37, 0x7f20, 0x7f08, 0x7eef, 0x7ed4, 0x7eb9, 0x7e9c, 0x7e7e, 0x7e5e, 0x7e3e, 0x7e1c, 0x7df9, 0x7dd5, 0x7db0, 0x7d89, 0x7d61, 0x7d38, 0x7d0e, 0x7ce2, 0x7cb6, 0x7c88, 0x7c59, 0x7c29, 0x7bf7, 0x7bc4, 0x7b91, 0x7b5c, 0x7b25, 0x7aee, 0x7ab5, 0x7a7c, 0x7a41, 0x7a04, 0x79c7, 0x7989, 0x7949, 0x7908, 0x78c6, 0x7883, 0x783f, 0x77f9, 0x77b3, 0x776b, 0x7722, 0x76d8, 0x768d, 0x7640, 0x75f3, 0x75a4, 0x7554, 0x7503, 0x74b1, 0x745e, 0x740a, 0x73b5, 0x735e, 0x7306, 0x72ae, 0x7254, 0x71f9, 0x719d, 0x7140, 0x70e1, 0x7082, 0x7022, 0x6fc0, 0x6f5e, 0x6efa, 0x6e95, 0x6e30, 0x6dc9, 0x6d61, 0x6cf8, 0x6c8e, 0x6c23, 0x6bb7, 0x6b4a, 0x6adb, 0x6a6c, 0x69fc, 0x698b, 0x6919, 0x68a5, 0x6831, 0x67bc, 0x6745, 0x66ce, 0x6656, 0x65dd, 0x6562, 0x64e7, 0x646b, 0x63ee, 0x6370, 0x62f1, 0x6271, 0x61f0, 0x616e, 0x60eb, 0x6067, 0x5fe2, 0x5f5d, 0x5ed6, 0x5e4f, 0x5dc6, 0x5d3d, 0x5cb3, 0x5c28, 0x5b9c, 0x5b0f, 0x5a81, 0x59f3, 0x5963, 0x58d3, 0x5842, 0x57b0, 0x571d, 0x5689, 0x55f4, 0x555f, 0x54c9, 0x5432, 0x539a, 0x5301, 0x5268, 0x51ce, 0x5133, 0x5097, 0x4ffa, 0x4f5d, 0x4ebf, 0x4e20, 0x4d80, 0x4ce0, 0x4c3f, 0x4b9d, 0x4afa, 0x4a57, 0x49b3, 0x490e, 0x4869, 0x47c3, 0x471c, 0x4674, 0x45cc, 0x4523, 0x447a, 0x43d0, 0x4325, 0x4279, 0x41cd, 0x4120, 0x4073, 0x3fc5, 0x3f16, 0x3e67, 0x3db7, 0x3d07, 0x3c56, 0x3ba4, 0x3af2, 0x3a3f, 0x398c, 0x38d8, 0x3824, 0x376f, 0x36b9, 0x3603, 0x354d, 0x3496, 0x33de, 0x3326, 0x326d, 0x31b4, 0x30fb, 0x3041, 0x2f86, 0x2ecc, 0x2e10, 0x2d54, 0x2c98, 0x2bdb, 0x2b1e, 0x2a61, 0x29a3, 0x28e5, 0x2826, 0x2767, 0x26a7, 0x25e7, 0x2527, 0x2467, 0x23a6, 0x22e4, 0x2223, 0x2161, 0x209f, 0x1fdc, 0x1f19, 0x1e56, 0x1d93, 0x1ccf, 0x1c0b, 0x1b46, 0x1a82, 0x19bd, 0x18f8, 0x1833, 0x176d, 0x16a7, 0x15e1, 0x151b, 0x1455, 0x138e, 0x12c7, 0x1200, 0x1139, 0x1072, 0xfab, 0xee3, 0xe1b, 0xd53, 0xc8b, 0xbc3, 0xafb, 0xa32, 0x96a, 0x8a1, 0x7d9, 0x710, 0x647, 0x57e, 0x4b6, 0x3ed, 0x324, 0x25b, 0x192, 0xc9, 0000, 0xff37, 0xfe6e, 0xfda5, 0xfcdc, 0xfc13, 0xfb4a, 0xfa82, 0xf9b9, 0xf8f0, 0xf827, 0xf75f, 0xf696, 0xf5ce, 0xf505, 0xf43d, 0xf375, 0xf2ad, 0xf1e5, 0xf11d, 0xf055, 0xef8e, 0xeec7, 0xee00, 0xed39, 0xec72, 0xebab, 0xeae5, 0xea1f, 0xe959, 0xe893, 0xe7cd, 0xe708, 0xe643, 0xe57e, 0xe4ba, 0xe3f5, 0xe331, 0xe26d, 0xe1aa, 0xe0e7, 0xe024, 0xdf61, 0xde9f, 0xdddd, 0xdd1c, 0xdc5a, 0xdb99, 0xdad9, 0xda19, 0xd959, 0xd899, 0xd7da, 0xd71b, 0xd65d, 0xd59f, 0xd4e2, 0xd425, 0xd368, 0xd2ac, 0xd1f0, 0xd134, 0xd07a, 0xcfbf, 0xcf05, 0xce4c, 0xcd93, 0xccda, 0xcc22, 0xcb6a, 0xcab3, 0xc9fd, 0xc947, 0xc891, 0xc7dc, 0xc728, 0xc674, 0xc5c1, 0xc50e, 0xc45c, 0xc3aa, 0xc2f9, 0xc249, 0xc199, 0xc0ea, 0xc03b, 0xbf8d, 0xbee0, 0xbe33, 0xbd87, 0xbcdb, 0xbc30, 0xbb86, 0xbadd, 0xba34, 0xb98c, 0xb8e4, 0xb83d, 0xb797, 0xb6f2, 0xb64d, 0xb5a9, 0xb506, 0xb463, 0xb3c1, 0xb320, 0xb280, 0xb1e0, 0xb141, 0xb0a3, 0xb006, 0xaf69, 0xaecd, 0xae32, 0xad98, 0xacff, 0xac66, 0xabce, 0xab37, 0xaaa1, 0xaa0c, 0xa977, 0xa8e3, 0xa850, 0xa7be, 0xa72d, 0xa69d, 0xa60d, 0xa57f, 0xa4f1, 0xa464, 0xa3d8, 0xa34d, 0xa2c3, 0xa23a, 0xa1b1, 0xa12a, 0xa0a3, 0xa01e, 0x9f99, 0x9f15, 0x9e92, 0x9e10, 0x9d8f, 0x9d0f, 0x9c90, 0x9c12, 0x9b95, 0x9b19, 0x9a9e, 0x9a23, 0x99aa, 0x9932, 0x98bb, 0x9844, 0x97cf, 0x975b, 0x96e7, 0x9675, 0x9604, 0x9594, 0x9525, 0x94b6, 0x9449, 0x93dd, 0x9372, 0x9308, 0x929f, 0x9237, 0x91d0, 0x916b, 0x9106, 0x90a2, 0x9040, 0x8fde, 0x8f7e, 0x8f1f, 0x8ec0, 0x8e63, 0x8e07, 0x8dac, 0x8d52, 0x8cfa, 0x8ca2, 0x8c4b, 0x8bf6, 0x8ba2, 0x8b4f, 0x8afd, 0x8aac, 0x8a5c, 0x8a0d, 0x89c0, 0x8973, 0x8928, 0x88de, 0x8895, 0x884d, 0x8807, 0x87c1, 0x877d, 0x873a, 0x86f8, 0x86b7, 0x8677, 0x8639, 0x85fc, 0x85bf, 0x8584, 0x854b, 0x8512, 0x84db, 0x84a4, 0x846f, 0x843c, 0x8409, 0x83d7, 0x83a7, 0x8378, 0x834a, 0x831e, 0x82f2, 0x82c8, 0x829f, 0x8277, 0x8250, 0x822b, 0x8207, 0x81e4, 0x81c2, 0x81a2, 0x8182, 0x8164, 0x8147, 0x812c, 0x8111, 0x80f8, 0x80e0, 0x80c9, 0x80b4, 0x809f, 0x808c, 0x807a, 0x806a, 0x805a, 0x804c, 0x803f, 0x8033, 0x8029, 0x8020, 0x8018, 0x8011, 0x800b, 0x8007, 0x8004, 0x8002, 0x8001, 0x8002, 0x8004, 0x8007, 0x800b, 0x8011, 0x8018, 0x8020, 0x8029, 0x8033, 0x803f, 0x804c, 0x805a, 0x806a, 0x807a, 0x808c, 0x809f, 0x80b4, 0x80c9, 0x80e0, 0x80f8, 0x8111, 0x812c, 0x8147, 0x8164, 0x8182, 0x81a2, 0x81c2, 0x81e4, 0x8207, 0x822b, 0x8250, 0x8277, 0x829f, 0x82c8, 0x82f2, 0x831e, 0x834a, 0x8378, 0x83a7, 0x83d7, 0x8409, 0x843c, 0x846f, 0x84a4, 0x84db, 0x8512, 0x854b, 0x8584, 0x85bf, 0x85fc, 0x8639, 0x8677, 0x86b7, 0x86f8, 0x873a, 0x877d, 0x87c1, 0x8807, 0x884d, 0x8895, 0x88de, 0x8928, 0x8973, 0x89c0, 0x8a0d, 0x8a5c, 0x8aac, 0x8afd, 0x8b4f, 0x8ba2, 0x8bf6, 0x8c4b, 0x8ca2, 0x8cfa, 0x8d52, 0x8dac, 0x8e07, 0x8e63, 0x8ec0, 0x8f1f, 0x8f7e, 0x8fde, 0x9040, 0x90a2, 0x9106, 0x916b, 0x91d0, 0x9237, 0x929f, 0x9308, 0x9372, 0x93dd, 0x9449, 0x94b6, 0x9525, 0x9594, 0x9604, 0x9675, 0x96e7, 0x975b, 0x97cf, 0x9844, 0x98bb, 0x9932, 0x99aa, 0x9a23, 0x9a9e, 0x9b19, 0x9b95, 0x9c12, 0x9c90, 0x9d0f, 0x9d8f, 0x9e10, 0x9e92, 0x9f15, 0x9f99, 0xa01e, 0xa0a3, 0xa12a, 0xa1b1, 0xa23a, 0xa2c3, 0xa34d, 0xa3d8, 0xa464, 0xa4f1, 0xa57f, 0xa60d, 0xa69d, 0xa72d, 0xa7be, 0xa850, 0xa8e3, 0xa977, 0xaa0c, 0xaaa1, 0xab37, 0xabce, 0xac66, 0xacff, 0xad98, 0xae32, 0xaecd, 0xaf69, 0xb006, 0xb0a3, 0xb141, 0xb1e0, 0xb280, 0xb320, 0xb3c1, 0xb463, 0xb506, 0xb5a9, 0xb64d, 0xb6f2, 0xb797, 0xb83d, 0xb8e4, 0xb98c, 0xba34, 0xbadd, 0xbb86, 0xbc30, 0xbcdb, 0xbd87, 0xbe33, 0xbee0, 0xbf8d, 0xc03b, 0xc0ea, 0xc199, 0xc249, 0xc2f9, 0xc3aa, 0xc45c, 0xc50e, 0xc5c1, 0xc674, 0xc728, 0xc7dc, 0xc891, 0xc947, 0xc9fd, 0xcab3, 0xcb6a, 0xcc22, 0xccda, 0xcd93, 0xce4c, 0xcf05, 0xcfbf, 0xd07a, 0xd134, 0xd1f0, 0xd2ac, 0xd368, 0xd425, 0xd4e2, 0xd59f, 0xd65d, 0xd71b, 0xd7da, 0xd899, 0xd959, 0xda19, 0xdad9, 0xdb99, 0xdc5a, 0xdd1c, 0xdddd, 0xde9f, 0xdf61, 0xe024, 0xe0e7, 0xe1aa, 0xe26d, 0xe331, 0xe3f5, 0xe4ba, 0xe57e, 0xe643, 0xe708, 0xe7cd, 0xe893, 0xe959, 0xea1f, 0xeae5, 0xebab, 0xec72, 0xed39, 0xee00, 0xeec7, 0xef8e, 0xf055, 0xf11d, 0xf1e5, 0xf2ad, 0xf375, 0xf43d, 0xf505, 0xf5ce, 0xf696, 0xf75f, 0xf827, 0xf8f0, 0xf9b9, 0xfa82, 0xfb4a, 0xfc13, 0xfcdc, 0xfda5, 0xfe6e, 0xff37, 0x0000};


void NCOinitialize(struct NCO *n, uint32_t samp_period){
  n->period = &CT_ECAP.CAP1;
  n->sin_accumulator = 0;
  n->cos_accumulator = (QSIZE << 16);
  n->sample_period = samp_period;
  n->sin_output = sinLUT[0];
  n->cos_output = sinLUT[QSIZE];
  NCOsetfreq(n);
}

void NCOsetfreq(struct NCO *n){
  uint32_t norm_period = 0;
  uint32_t temp_period = 0;

  temp_period = *(n->period) / 100;
  norm_period = POW / temp_period;
  n->incrementor = (uint64_t)norm_period * (uint64_t)n->sample_period;
}

void NCOinterpolate(struct NCO *n){
  uint16_t sin_index, cos_index = 0;
  int16_t sin_out1, sin_out2 = 0;
  int16_t cos_out1, cos_out2 = 0;
  uint16_t sin_fraction, cos_fraction = 0;
  int32_t sin_outfrac, cos_outfrac = 0;
  int16_t sin_diff, cos_diff = 0;

  /* Extract int part of accumulator */
  sin_index = n->sin_accumulator >> 16;
  cos_index = n->cos_accumulator >> 16;

  /* Ectract frac part of accumulator */
  sin_fraction = FRAC & n->sin_accumulator;
  cos_fraction = FRAC & n->cos_accumulator;

  /* Find LUT output and next output */
  sin_out1 = sinLUT[sin_index];
  sin_out2 = sinLUT[sin_index + 1];

  cos_out1 = sinLUT[cos_index];
  cos_out2 = sinLUT[cos_index + 1];

/*     Calculate the fractional part
 *       Add it to the integer part
 *
 *  Out = out1 + (out2 - out1) / 2n * t
 *    t = fractional part of the index
 * n = number of bits in fractional part
 *   out1 = current output - frac part
 *          out2 = the next output
 */
  sin_diff = sin_out2 - sin_out1;
  cos_diff = cos_out2 - cos_out1;


  sin_outfrac = sin_diff * sin_fraction;
  cos_outfrac = cos_diff * cos_fraction;

  sin_outfrac >>= 16;
  cos_outfrac >>= 16;

  n->sin_output = (sin_out1 + sin_outfrac);
  n->cos_output = (cos_out1 + cos_outfrac);
}

void NCOstep(struct NCO *n){
  NCOinterpolate(n);
  n->sin_accumulator = n->sin_accumulator + n->incrementor;
  n->cos_accumulator = n->cos_accumulator + n->incrementor;
  n->sin_accumulator &= (POW) - 1;
  n->cos_accumulator &= (POW) - 1;
}

#endif
