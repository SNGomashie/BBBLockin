# Lock-in Amplifier simulations
Our final goal is implementing a lock-in amplifier on the PRUs. A lock-in amplifier is a type of amplifier which is capable of retrieving a signal buried in noise. It does this by using phase sensitive detection for their operation.

## General overview
For our digital lock-in amplifier we have 2 inputs:
1. The signal to be measured (experiment signal)
2. The reference signal

typically the experiment is excited using a function generator from which we can use the SYNC signal as a reference signal.
<img src="https://i.imgur.com/0C2OYwe.png" alt="drawing"/>

A sinus and cosinus will be generated within the PRUs using a Phase locked loop (PLL) and a lookup table(LUT). Internally we will have 3 signals, the incoming experiment signal and the sinus/cosinus we are generating with the PLL.
<img src="https://i.imgur.com/YxdZsuN.png" alt="drawing"/>

In our simulations the signal will be generated by the formula:

VsigCos = 1.8 * cos((t * 2 * pi * Fr) - (pi / 10))

This will give a pi/10 phase shift relative to our reference signal which is generated in simulation by the formula:

VrefCos = cos(t * 2 * pi * Fr)

VrefSin = cos((t * 2 * pi * Fr) - (pi / 2))

In real life our experiment signal would be flooded with noise. We will assume a Singal-to-Noise-Ratio(SNR) of -20dB. We also assume a reference frequency of 100Hz. This frequency is chosen because this is a realistic frequency for the chopper. Graphically this would look like the image below. As you can see the original signal is unrecognizable:

<img src="https://i.imgur.com/whH4mD3.png" alt="drawing"/>

The frequency spectrum bears the answer, if we look at the image below we can see the Fast Fourier Transform(FFT) of the signals above. We can see a definite peak at 100Hz. This is where our information is hidden:

<img src="https://i.imgur.com/pooe81f.png" alt="drawing"/>



Using phase sensitive detection(PSD) or a multiplier we multiply our reference signals with the experiment signal. The output of this multiplication will be 2 new sinusoids at the sum and difference frequency. If the reference frequency and the experiment signal frequency are equal this will always create a DC component(Difference) and a component at 200Hz(Sum). This is shown in the graph below by taking the FFT from the results. We can clearly see a peak at 0Hz and 200Hz. To extract the DC component from our signal we will have to pass the output of the PSD through a low-pass filter with very low cut-off frequency. For our example we'll use a moving average filter implemented by taking the mean of all the results:

<img src="https://i.imgur.com/W6NDSCh.png" alt="drawing"/>

Multiplying the experiment signal with the reference sinus and cosinus will result in 2 answers. One will be proportional to the reference sinus and one will be proportional to the cosinus. These output will be called X and Y where X = experiment signal * reference cos and Y = experiment signal * reference sin. These quantities represent the signal as vectors relative to the reference signal. X is called the 'in-phase' component en Y the 'quadrature' component. This is because when the phase difference between reference and signal = 0 then X will measure the signal and Y will measure 0. If we calculate the magnitude of the signal vector the phase dependency is removed.

the magnitude(R) is calculated by:

R = 2 * (X2 + Y2)1/2 = experiment result

the phase difference between signal and reference is calculated by:

Î¸ = tan-1 (Y/X)

## Considerations

__Noise immunity__

Defines the level of noise the Lock-in amplifier can withstand without introducing error into the signal. The goal of this project is to create a lock-in amplifier capable of withstanding a SNR -20dB. The SNR can be calculated by this equation:

ğ‘†ğ‘ğ‘… = 10 Ã— log10 (ğ‘ƒğ‘ ğ‘–ğ‘”ğ‘›ğ‘ğ‘™ / ğ‘ƒğ‘›ğ‘œğ‘–ğ‘ ğ‘’) (ğ‘‘ğµ)

## Goals

We want to determine what sample frequency will result in a noise immunity of -20dB. We have a constant phase and reference frequency our only variable is the sample frequency.

### Simulation method

We will be stepping through 3 different reference frequencies with 7 different sample frequencies. For each combination of sampling frequency and reference frequency we will be trying 100 different noise levels. At each of these noise we will be running 100 simulations of the LIA. We average these 100 results and calculate the SNR and error for each level. We will save at what SNR the error became bigger than 0% for each combination of sample and reference frequency. The results of these simulations will tell us if the sample frequency requiered for 0% error at -20dB SNR is realistic or too high to implement on the Beaglebone PRUs

## Simulations

### Lock-in amplifier without noise
[Lock-in without noise](https://github.com/SNGomashie/BBBLockin/blob/master/Sim/SimNoNoise.py)

We'll start by simulating a Lock-in amplifier without any input noise. We do this to make sure our lock-in amplifier algorithm works.

This simulation showed us that our lock-in algorithm functions properly. It generates the graphs like we would expect them to be generated. Since we had no noise we also had 0 error. Read and Run the simulation to see the results.

### Lock-in amplifier with noise
[Lock-in with noise](https://github.com/SNGomashie/BBBLockin/blob/master/Sim/SimNoise.py)

This is basically exactly the same code as with the previous example except for the fact that we are injecting noise into the single in this example. The goal of this simulation is to show that we can properly inject noise into our signal which is truly random. This is also the script we used to generate the graphs seen above.

This simulation showed us that we can properly inject noise into our signal. It also shows that our lock-in algorithm is still able to function properly if we choose the right sampling frequency. Read and Run the simulation to see the results
